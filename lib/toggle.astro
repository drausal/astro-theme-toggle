---
import type { HTMLAttributes } from 'astro/types'

import IconSunSvg from './icons/lucide-sun.astro'
import IconMoonSvg from './icons/lucide-moon.astro'

type Props = HTMLAttributes<'div'>
const props: Props = Astro.props
---

<astro-theme-toggle {...props}>
  <div class="astro-theme-toggle-icon-light">
    <slot name="icon-light">
      <IconSunSvg />
    </slot>
  </div>
  <div class="astro-theme-toggle-icon-dark">
    <slot name="icon-dark">
      <IconMoonSvg />
    </slot>
  </div>
</astro-theme-toggle>

<script>
  import { handleToggleClick } from './handle-toggle-click'

  class AstroThemeToggle extends HTMLElement {
    connectedCallback() {
      if (!this.hasAttribute('tabindex')) {
        this.setAttribute('tabindex', '0')
      }
      if (!this.hasAttribute('role')) {
        this.setAttribute('role', 'button')
      }
      const speed = this.hasAttribute('data-astro-theme-toggle-speed')
          ? parseFloat(this.getAttribute('data-astro-theme-toggle-speed'))
          : 500
      this.addEventListener('click', (event) => {
        
        handleToggleClick({ clientX: event.clientX, clientY: event.clientY, speed })
      })
      this.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault()
          const rect = this.getBoundingClientRect()
          const clientX = rect.left + rect.width / 2
          const clientY = rect.top + rect.height / 2
          handleToggleClick({ clientX, clientY, speed })
        }
      })
    }
  }

  customElements.define('astro-theme-toggle', AstroThemeToggle)
</script>

<style is:global>
  astro-theme-toggle {
    display: block;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .astro-theme-toggle-icon-light,
  .astro-theme-toggle-icon-dark {
    width: 100%;
    height: 100%;

    & * {
      display: block;
    }
  }

  .astro-theme-toggle-icon-light {
    display: block;

    .dark & {
      display: none;
    }
  }

  .astro-theme-toggle-icon-dark {
    display: none;

    .dark & {
      display: block;
    }
  }
</style>
